<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mech Assault Walker - Pro Controller</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #050505; overflow: hidden; font-family: 'Courier New', monospace; color: #00ff64; }

        /* Landscape Orientation Guard */
        #orientation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        @media screen and (orientation: portrait) {
            #orientation-overlay { display: flex; }
        }

        #canvas-container { position: absolute; top: 0; width: 100%; height: 100%; }

        /* Combat UI */
        .controls {
            position: absolute; bottom: 10px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px; z-index: 10;
        }
        .joy-pad, .action-pad { display: grid; gap: 8px; }
        .joy-pad { grid-template-columns: repeat(3, 50px); }
        .action-pad { grid-template-columns: repeat(2, 70px); }

        button {
            background: rgba(0, 255, 100, 0.1); border: 1px solid #00ff64;
            color: #00ff64; border-radius: 5px; padding: 10px;
            font-size: 10px; font-weight: bold; backdrop-filter: blur(5px);
            touch-action: manipulation;
        }
        button:active { background: #00ff64; color: black; }
        
        .header { position: absolute; top: 10px; left: 10px; font-size: 12px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="orientation-overlay">
        <h1>⚠️ ROTATE DEVICE</h1>
        <p>Please use Landscape Mode for Mech Control</p>
    </div>

    <div class="header">MECH_UNIT: ASSAULT_WALKER_V2<br>PILOT: ANUBIS DIGITAL</div>

    <div id="canvas-container"></div>

    <div class="controls">
        <div class="joy-pad">
            <div></div><button onpointerdown="move('walk')" onpointerup="stop()">WALK</button><div></div>
            <button onpointerdown="move('left')" onpointerup="stop()">L</button>
            <button onpointerdown="move('run')" onpointerup="stop()">RUN</button>
            <button onpointerdown="move('right')" onpointerup="stop()">R</button>
        </div>

        <div class="action-pad">
            <button onclick="playAction('jump')">JUMP</button>
            <button onclick="playAction('fight')">ATTACK</button>
            <button onclick="playAction('dance')">DANCE</button>
            <button onclick="playAction('idle')">IDLE</button>
        </div>
    </div>

    <script>
        let scene, camera, renderer, mech, mixer, clock;
        let actions = {}; 
        let currentAction;
        let moveState = { active: false, speed: 0 };

        function init() {
            scene = new THREE.Scene();
            clock = new THREE.Clock();
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 12);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputEncoding = THREE.sRGBEncoding;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Lighting
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const pointLight = new THREE.PointLight(0x00ff64, 2, 50);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);

            // Floor
            const grid = new THREE.GridHelper(100, 40, 0x00ff64, 0x111111);
            scene.add(grid);

            // Loader
            const loader = new THREE.GLTFLoader();
            loader.load('Mech Assault Walker.glb', (gltf) => {
                mech = gltf.scene;
                scene.add(mech);

                mixer = new THREE.AnimationMixer(mech);
                
                // Map all animations to lowercase for easier calling
                gltf.animations.forEach((clip) => {
                    const name = clip.name.toLowerCase();
                    actions[name] = mixer.clipAction(clip);
                    console.log("Found animation:", name);
                });

                // Default state
                playAction('idle');
            }, undefined, (e) => console.error("Model Error:", e));

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function playAction(name) {
            // Find the animation even if the name is slightly different (e.g. "walk_loop")
            const clip = Object.keys(actions).find(k => k.includes(name));
            
            if (actions[clip]) {
                if (currentAction) currentAction.fadeOut(0.2);
                currentAction = actions[clip];
                currentAction.reset().fadeIn(0.2).play();
            }
        }

        function move(type) {
            moveState.active = true;
            if (type === 'walk') { moveState.speed = 0.05; playAction('walk'); }
            if (type === 'run') { moveState.speed = 0.15; playAction('run'); }
            if (type === 'left') mech.rotation.y += 0.5;
            if (type === 'right') mech.rotation.y -= 0.5;
        }

        function stop() {
            moveState.active = false;
            playAction('idle');
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);

            if (moveState.active && mech) {
                // Move forward based on mech's current rotation
                mech.translateZ(moveState.speed);
                // Camera Follow
                camera.lookAt(mech.position);
            }
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
